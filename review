#!/usr/bin/env bash
set -Eeuo pipefail

# === Paths ===
PROMPT_FILE="$HOME/utils/review-system/prompt_md-output.md"
findnotes="$HOME/utils/review-system/src/find_yesterdays_notes.sh"

VAULT="$HOME/Vault"
REVIEW="$VAULT/Review"
YESTERDAY_NOTES="$REVIEW/yesterday_notes"
REVIEWS_DIR="$REVIEW/reviews"

# === Date ===
DATE="$(date -d "yesterday" +"%d-%m-%Y")"

# === Output files ===
YESTERDAY_FILE="$YESTERDAY_NOTES/${DATE}.md"
REVIEW_FILE="$REVIEWS_DIR/${DATE}.md"

# === Ensure dirs exist ===
mkdir -p "$YESTERDAY_NOTES" "$REVIEWS_DIR"

# === Get yesterday's files from your finder script (one path per line) ===
rm $YESTERDAY_FILE $REVIEW_FILE
mapfile -t FILES < <("$findnotes" "$VAULT")

if ((${#FILES[@]} == 0)); then
  echo "No notes found for yesterday in: $VAULT"
  exit 0
fi

# === Concatenate notes into a single file (handles spaces safely) ===
{
  echo "# Notes from $DATE"
  echo
  for f in "${FILES[@]}"; do
    [[ -n "$f" ]] || continue
    echo
    echo "----- $(basename "$f") -----"
    echo
    cat "$f"
    echo
  done
} > "$YESTERDAY_FILE"

echo "✅ Consolidated notes: $YESTERDAY_FILE"

# # === Compose model input: PROMPT first, then the NOTES ===
# MODEL_INPUT="$(mktemp)"
# {
#   cat "$PROMPT_FILE"
#   echo
#   echo "### NOTES ###"
#   cat "$YESTERDAY_FILE"
# } > "$MODEL_INPUT"

# === Run Gemini (alias -> npx gemini). -p " " forces non-interactive mode. ===
echo "Running LLM..."
npx gemini -p "$(cat ${PROMPT_FILE})${YESTERDAY_FILE}" > $REVIEW_FILE

echo "✅ Review generated: $REVIEW_FILE"
